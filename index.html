<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Training Schedule Generator v3.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .input-group label { display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.25rem; }
        .input-group input:not([type="checkbox"]):not([type="file"]), .input-group select, .input-group textarea { 
            width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; transition: border-color 0.2s; 
        }
        .input-group input:focus, .input-group textarea:focus { outline: none; border-color: #2563eb; ring: 2px solid #93c5fd; }
        .input-group.error input, .input-group.error textarea { border-color: #ef4444; }

        .checkbox-wrapper { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .checkbox-label { display: flex; align-items: center; background: #fff; padding: 0.25rem 0.75rem; border: 1px solid #e5e7eb; border-radius: 9999px; cursor: pointer; font-size: 0.85rem; user-select: none; transition: all 0.2s; }
        .checkbox-label:hover { border-color: #2563eb; }
        .checkbox-label input:checked + span { color: #2563eb; font-weight: bold; background-color: #eff6ff; border-color: #2563eb; }
        
        .editable-input { width: 100%; border: none; background: transparent; padding: 4px; font-family: inherit; }
        .editable-input:focus { background: #eff6ff; outline: 1px solid #2563eb; border-radius: 4px; }
        
        /* Save Indicator */
        #saveIndicator { transition: opacity 0.5s; opacity: 0; }
        #saveIndicator.show { opacity: 1; }

        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Styles for Excluded Dates List */
        .excluded-date-item { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 0.25rem 0.5rem; border-radius: 0.375rem; margin-top: 0.25rem; border: 1px solid #e5e7eb; }

        /* Mobile Responsiveness for Main Layout */
        @media (max-width: 1023px) {
            .lg\:grid-cols-4 { grid-template-columns: 1fr; }
            .lg\:col-span-1, .lg\:col-span-3 { grid-column: span 1 / span 1; }
            .lg\:col-span-1 { border-right: none; border-bottom: 1px solid #e5e7eb; }
        }

        /* Mobile Table Fix: Ensure scrollability is the primary method for data-heavy tables */
        .schedule-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* For smooth scrolling on iOS */
        }
        .schedule-table-container table {
            min-width: 700px; /* Ensure table is wide enough to scroll on mobile */
        }
    </style>
</head>
<body class="text-gray-800 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-xl overflow-hidden fade-in">
        
        <header class="bg-slate-900 text-white p-6 border-b border-gray-200 flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <div>
                <h1 class="text-2xl font-bold">Training Schedule Generator</h1>
                <p class="text-slate-400 text-sm mt-1">Professional Planning Tool</p>
            </div>
            <div class="flex items-center gap-4 mt-3 sm:mt-0">
                <span id="saveIndicator" class="text-xs text-green-400 font-semibold flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    Saved locally
                </span>
                <button onclick="resetData()" class="text-xs bg-slate-700 hover:bg-slate-600 text-white py-2 px-3 rounded transition">
                    Reset / New
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4">
            
            <div class="lg:col-span-1 bg-gray-50 p-6 border-r border-gray-200 flex flex-col gap-4"> 
                <h2 class="text-lg font-bold text-gray-700 mb-1">Course Details</h2>
                
                <div class="input-group">
                    <label>Trainee Name <span class="text-red-500">*</span></label>
                    <input type="text" id="traineeName" placeholder="e.g. Basel" oninput="saveState()">
                </div>

                <!-- NEW: Course Selection Dropdown -->
                <div class="input-group">
                    <label>Select Course <span class="text-red-500">*</span></label>
                    <select id="courseSelect" onchange="handleCourseSelection(); saveState();">
                        <option value="">-- Select a Course --</option>
                        <option value="excel">Excel Mastery: From Zero to Hero</option>
                        <option value="powerbi">Power BI Business Insights Bootcamp.</option>
                        <option value="other">Other (Custom Course)</option>
                    </select>
                </div>

                <!-- REFINED: Single Course Name Input (Read-only for predefined, editable for custom) -->
                <div class="input-group">
                    <label>Course Name <span class="text-red-500">*</span></label>
                    <input type="text" id="courseName" placeholder="Course name will be set automatically or enter custom name" oninput="saveState()">
                </div>
                
                <div class="input-group">
                    <label>Company Logo (For PDF)</label>
                    <input type="file" id="logoUpload" accept="image/*">
                    <p class="text-xs text-gray-400 mt-1">Will be displayed on the top right.</p>
                    <div id="logoPreview" class="mt-2 hidden">
                        <img id="logoImg" class="w-20 h-20 object-contain border p-1 bg-white rounded shadow-sm" alt="Logo Preview">
                    </div>
                </div>

                <!-- REFINED: Course Topics Textarea (Read-only for predefined, editable for custom) -->
                <div class="input-group" id="courseTopicsGroup">
                    <label>Course Topics (One per line) <span class="text-red-500">*</span></label>
                    <textarea id="courseTopics" rows="8" placeholder="Topics will be loaded automatically or enter custom topics here." oninput="saveState()"></textarea>
                </div>

                <div class="input-group">
                    <label>Start Date <span class="text-red-500">*</span></label>
                    <input type="date" id="startDate" oninput="saveState()">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="input-group">
                        <label>Start Time <span class="text-red-500">*</span></label>
                        <input type="time" id="startTime" value="19:00" oninput="saveState()">
                    </div>
                    <div class="input-group">
                        <label>Hours/Day <span class="text-red-500">*</span></label>
                        <input type="number" id="dailyHours" value="2" min="0.5" step="0.5" oninput="saveState()">
                    </div>
                </div>

                <div class="input-group">
                    <label>Total Course Hours <span class="text-red-500">*</span></label>
                    <input type="number" id="totalHours" value="18" min="1" oninput="saveState()">
                </div>

                <div class="input-group">
                    <label>Training Days <span class="text-red-500">*</span></label>
                    <div class="flex gap-2 mb-2 flex-wrap" id="daysPresetButtons">
                        <button onclick="setDaysPreset(1)" class="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded transition">Sun-Thu</button>
                        <button onclick="setDaysPreset(2)" class="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded transition">Mon-Fri</button>
                        <button onclick="setDaysPreset(3)" class="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded transition">All Week</button>
                        <button onclick="setDaysPreset(4)" class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold px-2 py-1 rounded transition">Custom</button>
                    </div>
                    <div class="checkbox-wrapper" id="dayCheckboxes">
                        <label class="checkbox-label"><input type="checkbox" class="day-select hidden" value="0" onchange="saveState()"> <span>Sun</span></label>
                        <label class="checkbox-label"><input type="checkbox" class="day-select hidden" value="1" onchange="saveState()"> <span>Mon</span></label>
                        <label class="checkbox-label"><input type="checkbox" class="day-select hidden" value="2" onchange="saveState()"> <span>Tue</span></label>
                        <label class="checkbox-label"><input type="checkbox" class="day-select hidden" value="3" onchange="saveState()"> <span>Wed</span></label>
                        <label class="checkbox-label"><input type="checkbox" class="day-select hidden" value="4" onchange="saveState()"> <span>Thu</span></label>
                        <label class="checkbox-label"><input type="checkbox" class="day-select hidden" value="5" onchange="saveState()"> <span>Fri</span></label>
                        <label class="checkbox-label"><input type="checkbox" class="day-select hidden" value="6" onchange="saveState()"> <span>Sat</span></label>
                    </div>
                </div>

                <div class="input-group">
                    <label>Excluded Dates (Holidays)</label>
                    <div class="flex gap-2">
                        <input type="date" id="newExcludedDate">
                        <button onclick="addExcludedDate()" class="bg-gray-400 hover:bg-gray-500 text-white py-1 px-3 rounded">+</button>
                    </div>
                    <div id="excludedDatesList" class="text-sm mt-1">
                        </div>
                </div>

                <button onclick="generateSchedule()" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition shadow-lg" id="generateButton">
                    Generate Schedule
                </button>
            </div>

            <div class="lg:col-span-3 p-4 sm:p-6 flex flex-col h-full bg-white">
                
                <div id="placeholder" class="flex-1 flex flex-col items-center justify-center text-gray-400">
                    <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <p>Enter details and click Generate.</p>
                </div>

                <div id="resultsArea" class="hidden flex flex-col h-full">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-3">
                        <div>
                            <h3 class="text-xl sm:text-2xl font-bold text-gray-800">Generated Schedule</h3>
                            <p class="text-sm text-gray-500">Review and edit before exporting.</p>
                            <p class="mt-2 text-sm font-semibold">Total Hours: <span id="hoursSummary" class="text-blue-600">0</span> / <span id="targetHoursSummary" class="text-gray-500">0</span></p>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                            <button onclick="exportExcel()" class="flex-1 md:flex-none bg-green-600 hover:bg-green-700 text-white text-sm font-semibold py-2 px-4 rounded flex items-center justify-center gap-2 shadow">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                Excel
                            </button>
                            <button onclick="exportPDF()" class="flex-1 md:flex-none bg-red-600 hover:bg-red-700 text-white text-sm font-semibold py-2 px-4 rounded flex items-center justify-center gap-2 shadow">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                PDF
                            </button>
                        </div>
                    </div>

                    <div class="schedule-table-container flex-1">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Day</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remaining</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Schedule rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STRUCTURE FOR COURSES ---
        const coursesData = {
            'excel': {
                name: 'Excel Mastery: From Zero to Hero',
                topics: [
                    'Getting Started: Navigate interface, ribbons, commands',
                    'Create/save workbooks, enter & format data, shortcuts mastery.',
                    'Calculations & Functions: Formulas, XLOOKUP, logical, date/time, text, and dynamic array functions.',
                    'Worksheet & Workbook Management: Insert/delete/adjust cells, columns, rows',
                    'Find & replace; proofing & research tool',
                    'Manage views & workbook properties; links & external references.',
                    'Formatting & Visualization: Text & number formats, alignment, styles & themes, conditional formatting, page setup',
                    'Headers/footers, print preview; create/modify charts, advanced chart features.',
                    'Lists & Tables: Sort, filter, outline, subtotal, create/modify tables, structured references.',
                    'PivotTables & PivotCharts: Create, analyze, filter with slicers/timelines, present data visually.',
                    'Data Analysis & Insights: Conditional formatting, what-if analysis, data grouping',
                    'Scenario manager, basic statistical summaries.',
                    'Sharing & Protection: Collaboration, protect worksheets & workbooks, track changes.',
                    'Automation & Dashboards: Data validation, error checking, formula auditing, dashboard creation.',
                    'Dynamic reporting with slicers & field parameters.',
                    'Advanced Tips & Productivity: Power Query basics, keyboard shortcuts, templates, and time-saving hacks.'
                ].join('\n')
            },
            'powerbi': {
                name: 'Power BI Business Insights Bootcamp.',
                topics: [
                    'Getting Started: Navigate Power BI interface, ribbons, panes, and commands.',
                    'Data Import & Preparation: Connect to multiple data sources, clean & transform data with Power Query, manage relationships.',
                    'Data Modeling & Calculations: Create calculated columns & measures using DAX, logical, date/time, and text functions.',
                    'Data Management: Manage tables, relationships, hierarchies, and data types.',
                    'Formatting & Visualization: Apply themes, formatting, alignment, conditional formatting, create and customize visuals.',
                    'Reports & Dashboards: Build interactive reports, slicers, bookmarks, and tooltips; create dashboards for insights.',
                    'Advanced Analytics: Use measures, KPIs, grouping, What-If analysis, and time intelligence.',
                    'Sharing & Collaboration: Publish reports, manage workspaces, row-level security, and sharing options.',
                    'Automation & Refresh: Scheduled data refresh, alerts, and integrating with Power Automate.',
                    'Productivity & Tips: Power BI tips, keyboard shortcuts, templates, best practices, and performance optimization.'
                ].join('\n')
            }
        };

        // --- GLOBAL STATE ---
        let currentSchedule = [];
        let excludedDates = [];
        let logoBase64 = null;
        const daysMap = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        // --- UI HANDLERS ---

        function handleCourseSelection() {
            const select = document.getElementById('courseSelect');
            const courseNameInput = document.getElementById('courseName');
            const courseTopicsTextarea = document.getElementById('courseTopics');
            const selectedValue = select.value;

            if (selectedValue === 'other') {
                // Enable editing of name and topics
                courseNameInput.value = '';
                courseNameInput.readOnly = false;
                courseNameInput.placeholder = 'Enter custom course name';
                courseTopicsTextarea.value = '';
                courseTopicsTextarea.readOnly = false;
                courseTopicsTextarea.placeholder = 'Enter custom topics here, one per line.';
            } else if (coursesData[selectedValue]) {
                // Load predefined data, disable editing of name and topics
                const course = coursesData[selectedValue];
                courseNameInput.value = course.name;
                courseNameInput.readOnly = true;
                courseNameInput.placeholder = 'Predefined course name';
                courseTopicsTextarea.value = course.topics;
                courseTopicsTextarea.readOnly = true;
                courseTopicsTextarea.placeholder = 'Topics loaded from predefined course.';
            } else {
                // No selection - keep inputs editable and clear
                courseNameInput.value = '';
                courseNameInput.readOnly = false;
                courseNameInput.placeholder = 'Course name will be set automatically or enter custom name';
                courseTopicsTextarea.value = '';
                courseTopicsTextarea.readOnly = false;
                courseTopicsTextarea.placeholder = 'Topics will be loaded automatically or enter custom topics here.';
            }
            saveState();
        }

        // --- EXISTING FUNCTIONS (Modified for new elements) ---

        function setDaysPreset(preset) {
            const checkboxes = document.querySelectorAll('.day-select');
            checkboxes.forEach(cb => cb.checked = false);

            switch (preset) {
                case 1: // Sun-Thu (0, 1, 2, 3, 4)
                    [0, 1, 2, 3, 4].forEach(day => checkboxes[day].checked = true);
                    break;
                case 2: // Mon-Fri (1, 2, 3, 4, 5)
                    [1, 2, 3, 4, 5].forEach(day => checkboxes[day].checked = true);
                    break;
                case 3: // All Week (0-6)
                    checkboxes.forEach(cb => cb.checked = true);
                    break;
                case 4: // Custom - simply uncheck all to allow manual selection
                    // No action needed, already unchecked. This button serves as a visual reset to manual mode.
                    break;
            }
            saveState();
        }

        function addExcludedDate() {
            const dateInput = document.getElementById('newExcludedDate');
            const dateValue = dateInput.value;
            if (dateValue && !excludedDates.includes(dateValue)) {
                excludedDates.push(dateValue);
                excludedDates.sort();
                dateInput.value = '';
                renderExcludedDates();
                saveState();
            }
        }

        function removeExcludedDate(date) {
            excludedDates = excludedDates.filter(d => d !== date);
            renderExcludedDates();
            saveState();
        }

        function renderExcludedDates() {
            const list = document.getElementById('excludedDatesList');
            list.innerHTML = '';
            excludedDates.forEach(date => {
                const div = document.createElement('div');
                div.className = 'excluded-date-item';
                div.innerHTML = `
                    <span>${date} (${daysMap[new Date(date).getDay()]})</span>
                    <button onclick="removeExcludedDate('${date}')" class="text-red-500 hover:text-red-700 text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        // --- SCHEDULE GENERATION LOGIC ---

        function generateSchedule() {
            const traineeName = document.getElementById('traineeName').value;
            const courseName = document.getElementById('courseName').value;
            const startDateStr = document.getElementById('startDate').value;
            const startTimeStr = document.getElementById('startTime').value;
            const dailyHours = parseFloat(document.getElementById('dailyHours').value);
            const totalHours = parseFloat(document.getElementById('totalHours').value);
            const selectedDays = Array.from(document.querySelectorAll('.day-select:checked')).map(cb => parseInt(cb.value));

            // Validation
            if (!traineeName || !courseName || !startDateStr || !startTimeStr || isNaN(dailyHours) || dailyHours <= 0 || isNaN(totalHours) || totalHours <= 0 || selectedDays.length === 0) {
                alert("Please fill all required fields and select at least one training day.");
                return;
            }

            document.getElementById('placeholder').classList.add('hidden');
            document.getElementById('resultsArea').classList.remove('hidden');

            let currentDate = new Date(startDateStr);
            currentDate.setHours(0, 0, 0, 0); // Normalize to start of day
            
            let hoursScheduled = 0;
            let schedule = [];
            let sessionId = 1;

            const maxIterations = 365; // Safety break
            let iterationCount = 0;

            while (hoursScheduled < totalHours && iterationCount < maxIterations) {
                const dayOfWeek = currentDate.getDay(); // 0 = Sunday, 6 = Saturday
                const dateStr = currentDate.toISOString().split('T')[0];

                if (selectedDays.includes(dayOfWeek) && !excludedDates.includes(dateStr)) {
                    let hoursForThisSession = Math.min(dailyHours, totalHours - hoursScheduled);
                    
                    if (hoursForThisSession > 0) {
                        const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
                        const startT = new Date(currentDate);
                        startT.setHours(startHours, startMinutes, 0, 0);

                        const endT = new Date(startT.getTime() + hoursForThisSession * 60 * 60 * 1000);
                        
                        schedule.push({
                            id: sessionId++,
                            date: dateStr,
                            day: daysMap[dayOfWeek],
                            startTime: startTimeStr,
                            endTime: endT.toTimeString().slice(0, 5),
                            hours: hoursForThisSession
                        });

                        hoursScheduled += hoursForThisSession;
                    }
                }

                // Move to the next day
                currentDate.setDate(currentDate.getDate() + 1);
                iterationCount++;
            }

            currentSchedule = schedule;
            renderTable();
            saveState();
        }

        function renderTable() {
            const tbody = document.getElementById('scheduleTableBody');
            tbody.innerHTML = '';
            
            let runningTotal = 0;
            const targetTotal = parseFloat(document.getElementById('totalHours').value);

            currentSchedule.forEach((row, index) => {
                const hours = row.hours;
                runningTotal += hours;
                const remaining = targetTotal - runningTotal;

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition';
                tr.innerHTML = `
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.id}</td>
                    <td class="px-3 py-4">
                        <input type="date" class="editable-input text-xs" value="${row.date}" onchange="updateRow(${index}, 'date', this.value)">
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${row.day}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm">
                        <div class="flex flex-col">
                            <input type="time" class="editable-input text-xs" value="${row.startTime}" onchange="updateRow(${index}, 'startTime', this.value)">
                            <span class="text-gray-600 font-semibold">${row.endTime}</span>
                        </div>
                    </td>
                    <td class="px-3 py-4"><input type="number" class="editable-input w-12 text-xs" value="${hours}" step="0.5" min="0.5" onchange="updateRow(${index}, 'hours', this.value)"></td>
                    <td class="px-3 py-4 font-bold text-xs ${remaining > 0 ? 'text-blue-600' : 'text-green-600'}">${remaining.toFixed(1)}</td>
                    <td class="px-3 py-4">
                        <button onclick="deleteRow(${index})" class="text-red-500 hover:text-red-700 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Update Summary
            document.getElementById('hoursSummary').textContent = runningTotal.toFixed(1);
            document.getElementById('targetHoursSummary').textContent = targetTotal.toFixed(1);
        }

        function updateRow(index, field, value) {
            const row = currentSchedule[index];
            
            if (field === 'hours') {
                value = parseFloat(value);
                if (isNaN(value) || value <= 0) {
                    alert("Hours must be a positive number.");
                    renderTable(); 
                    return;
                }
                row.hours = value;
            } else if (field === 'date') {
                const d = new Date(value);
                row.day = daysMap[d.getDay()];
                row.date = value;
            } else if (field === 'startTime') {
                row.startTime = value;
            }
            
            // Re-calculate end time for current row
            const [startHours, startMinutes] = row.startTime.split(':').map(Number);
            const startT = new Date(2000, 0, 1, startHours, startMinutes);
            const endT = new Date(startT.getTime() + row.hours * 60 * 60 * 1000);
            row.endTime = endT.toTimeString().slice(0, 5);

            renderTable();
            saveState();
        }
        
        function deleteRow(index) {
            if (confirm("Are you sure you want to remove this session?")) {
                currentSchedule.splice(index, 1);
                currentSchedule.forEach((row, i) => row.id = i + 1); 
                renderTable();
                saveState();
            }
        }
        
        // --- LOCAL STORAGE & STATE MANAGEMENT ---

        function saveState() {
            const state = {
                traineeName: document.getElementById('traineeName').value,
                courseSelect: document.getElementById('courseSelect').value,
                courseName: document.getElementById('courseName').value,
                courseTopics: document.getElementById('courseTopics').value,
                startDate: document.getElementById('startDate').value,
                startTime: document.getElementById('startTime').value,
                dailyHours: document.getElementById('dailyHours').value,
                totalHours: document.getElementById('totalHours').value,
                selectedDays: Array.from(document.querySelectorAll('.day-select:checked')).map(cb => parseInt(cb.value)),
                excludedDates: excludedDates,
                currentSchedule: currentSchedule,
                logoBase64: logoBase64
            };
            localStorage.setItem('trainingScheduleState', JSON.stringify(state));
            
            // Show save indicator
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            clearTimeout(window.saveTimer);
            window.saveTimer = setTimeout(() => {
                indicator.classList.remove('show');
            }, 1500);
        }

        function loadState() {
            const savedState = localStorage.getItem('trainingScheduleState');
            if (savedState) {
                const state = JSON.parse(savedState);
                
                document.getElementById('traineeName').value = state.traineeName || '';
                document.getElementById('courseSelect').value = state.courseSelect || '';
                document.getElementById('startDate').value = state.startDate || '';
                document.getElementById('startTime').value = state.startTime || '19:00';
                document.getElementById('dailyHours').value = state.dailyHours || '2';
                document.getElementById('totalHours').value = state.totalHours || '18';
                
                // Handle course selection and topics
                document.getElementById('courseName').value = state.courseName || '';
                document.getElementById('courseTopics').value = state.courseTopics || '';
                handleCourseSelection(); // This will set readOnly and load predefined topics/name if applicable

                // Set selected days
                const checkboxes = document.querySelectorAll('.day-select');
                checkboxes.forEach(cb => cb.checked = false);
                if (state.selectedDays) {
                    state.selectedDays.forEach(day => {
                        const cb = Array.from(checkboxes).find(c => parseInt(c.value) === day);
                        if (cb) cb.checked = true;
                    });
                }

                // Set excluded dates
                excludedDates = state.excludedDates || [];
                renderExcludedDates();

                // Set schedule
                currentSchedule = state.currentSchedule || [];
                if (currentSchedule.length > 0) {
                    document.getElementById('placeholder').classList.add('hidden');
                    document.getElementById('resultsArea').classList.remove('hidden');
                    renderTable();
                }

                // Set logo
                logoBase64 = state.logoBase64 || null;
                if (logoBase64) {
                    document.getElementById('logoPreview').classList.remove('hidden');
                    document.getElementById('logoImg').src = logoBase64;
                }
            } else {
                // Initial load: ensure handleCourseSelection is called to set initial state
                handleCourseSelection();
            }
        }

        function resetData() {
            if (confirm("Are you sure you want to reset all data? This will clear local storage.")) {
                localStorage.removeItem('trainingScheduleState');
                window.location.reload();
            }
        }

        // --- LOGO HANDLER ---

        document.getElementById('logoUpload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    logoBase64 = e.target.result;
                    document.getElementById('logoPreview').classList.remove('hidden');
                    document.getElementById('logoImg').src = logoBase64;
                    saveState();
                };
                reader.readAsDataURL(file);
            } else {
                logoBase64 = null;
                document.getElementById('logoPreview').classList.add('hidden');
                document.getElementById('logoImg').src = '';
                saveState();
            }
        });

        // --- EXPORT FUNCTIONS ---
        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const trainee = document.getElementById('traineeName').value || "Name";
            const course = document.getElementById('courseName').value || "Course";
            
            const rawTopics = document.getElementById('courseTopics').value;
            const topics = rawTopics.split('\n').filter(t => t.trim() !== '');

           // Header Section
doc.setFillColor(0, 102, 102); // متناسق مع #099999
doc.rect(0, 0, 210, 40, 'F');

doc.setTextColor(255, 255, 255);
doc.setFontSize(22);
doc.text("Training Schedule", 14, 20);

doc.setFontSize(10);
doc.setTextColor(200, 200, 200);
doc.text(`Course: ${course}`, 14, 30);
doc.text(`Trainee: ${trainee}`, 14, 35);
const genDate = new Date().toLocaleDateString('en-GB'); 
doc.text(`Date: ${genDate}`, 120, 35);


            // Logo Integration
            if (logoBase64) {
                try {
                    const imgFormat = logoBase64.substring("data:image/".length, logoBase64.indexOf(";base64")).toUpperCase();
                    doc.addImage(logoBase64, imgFormat, 170, 5, 30, 30);  
                } catch (e) {
                    console.error("Error adding logo to PDF:", e);
                }
            }

            let tableStartY = 50;

            // Topics Section
            if (topics.length > 0) {
                doc.setTextColor(40, 40, 40);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text("Course Outline / Topics:", 14, 55);
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                
                let topicY = 62;
                topics.forEach(topic => {
                    doc.setFillColor(9, 135, 135);
                    doc.circle(16, topicY - 1, 1, 'F');  
                    doc.text(topic, 20, topicY);
                    topicY += 6; 
                });

                tableStartY = topicY + 10;
            }
// Table Section
const tableData = currentSchedule.map(row => {
    const dateObj = new Date(row.date);
    const formattedDate = `${String(dateObj.getDate()).padStart(2,'0')}/${String(dateObj.getMonth()+1).padStart(2,'0')}/${dateObj.getFullYear()}`;
    return [
        row.id,
        formattedDate,
        row.day,
        `${row.startTime} - ${row.endTime}`,
        row.hours.toFixed(1) + ' hrs'
    ];
});

// Add Total Hours row
const totalHours = currentSchedule.reduce((sum, row) => sum + row.hours, 0);
tableData.push([
    '',
    '',
    '',
    { content: 'Total Hours', styles: { fontStyle: 'bold', fillColor: [200, 200, 200] } },
    { content: totalHours.toFixed(1) + ' hrs', styles: { fontStyle: 'bold', fillColor: [200, 200, 200] } }
]);

doc.autoTable({
    head: [['#', 'Date', 'Day', 'Time', 'Duration']],
    body: tableData,
    startY: tableStartY,
    theme: 'grid',
    headStyles: { fillColor: [9, 153, 153], textColor: 255, fontStyle: 'bold' },
    styles: { fontSize: 10, cellPadding: 4 },
    alternateRowStyles: { fillColor: [243, 244, 246] }
});


            // Footer
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text("Approved By: ___________________", 14, doc.internal.pageSize.height - 20);
            
doc.save(`${trainee}_Schedule.pdf`);
        }

        function exportExcel() {
            const trainee = document.getElementById('traineeName').value || "Trainee";
            const course = document.getElementById('courseName').value || "Course";
            
            const rawTopics = document.getElementById('courseTopics').value;
            
            const ws_data = [
                ["TRAINING SCHEDULE"],
                ["Course Name", course],
                ["Trainee Name", trainee],
                ["Generated Date", new Date().toLocaleDateString()],
                [""]
            ];

            if (rawTopics.trim()) {
                ws_data.push(["Course Topics:"]);
                const topics = rawTopics.split('\n').filter(t => t.trim() !== '');
                topics.forEach(t => ws_data.push(["• " + t]));
                ws_data.push([""]);  
            }

            ws_data.push(["Session", "Date", "Day", "Start Time", "End Time", "Duration (Hrs)"]);

            currentSchedule.forEach(row => {
                ws_data.push([
                    row.id, row.date, row.day, row.startTime, row.endTime, row.hours
                ]);
            });

            // Add Total Hours row
            const totalHours = currentSchedule.reduce((sum, row) => sum + row.hours, 0);
            ws_data.push(["", "", "", "", "Total Hours", totalHours.toFixed(1)]);

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            ws['!cols'] = [{wch: 15}, {wch: 15}, {wch: 15}, {wch: 12}, {wch: 12}, {wch: 15}];

            XLSX.utils.book_append_sheet(wb, ws, "Schedule");
            XLSX.writeFile(wb, `${course}_${trainee}_Schedule.xlsx`);
        }

        // --- INITIALIZATION ---
        window.onload = loadState;
    </script>
</body>
</html>
