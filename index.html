<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>X Academy Schedule Wizard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { 
            font-family: 'Outfit', sans-serif; 
            background: #0f172a;
            color: white;
            overflow-x: hidden;
        }

        /* Moving Gradient Background */
        .bg-animated {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            z-index: -1;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glassmorphism Card */
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        /* Form Elements */
        .glass-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            background: rgba(0, 0, 0, 0.4);
            border-color: #23d5ab;
            outline: none;
            box-shadow: 0 0 0 2px rgba(35, 213, 171, 0.2);
        }

        /* Steps Animation */
        .step-content {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        .step-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom Checkbox for Days */
        .day-checkbox:checked + div {
            background: #23d5ab;
            color: #0f172a;
            border-color: #23d5ab;
            font-weight: bold;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

        /* Loader */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #23d5ab;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="bg-animated"></div>
    <div class="absolute inset-0 bg-black/40 z-[-1]"></div> <div class="glass-card w-full max-w-lg md:max-w-4xl rounded-3xl overflow-hidden relative flex flex-col max-h-[90vh]">
        
        <div class="p-6 border-b border-white/10 flex justify-between items-center bg-black/20">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-400 to-teal-400 flex items-center justify-center font-bold text-lg shadow-lg">
                    X
                </div>
                <div>
                    <h1 class="font-bold text-lg tracking-wide">Schedule Wizard</h1>
                    <div class="flex gap-1 mt-1">
                        <div id="prog-1" class="h-1 w-6 rounded-full bg-teal-400 transition-all"></div>
                        <div id="prog-2" class="h-1 w-6 rounded-full bg-white/20 transition-all"></div>
                        <div id="prog-3" class="h-1 w-6 rounded-full bg-white/20 transition-all"></div>
                        <div id="prog-4" class="h-1 w-6 rounded-full bg-white/20 transition-all"></div>
                    </div>
                </div>
            </div>
            <button onclick="resetApp()" class="text-white/60 hover:text-white transition" title="Reset">
                <i class="fa-solid fa-rotate-right"></i>
            </button>
        </div>

        <div class="p-6 md:p-8 overflow-y-auto flex-1 custom-scrollbar relative">
            
            <div id="step-1" class="step-content active">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold mb-2">Who are we training?</h2>
                    <p class="text-white/60">Let's start with the basics.</p>
                </div>

                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold mb-2 ml-1">Trainee Name</label>
                        <input type="text" id="traineeName" class="glass-input w-full p-4 rounded-xl text-lg" placeholder="e.g. Basel Ghanem">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2 ml-1">Company Logo (Optional)</label>
                        <label class="flex items-center gap-4 p-4 rounded-xl glass-input cursor-pointer hover:bg-white/5 transition group">
                            <div class="w-12 h-12 rounded-lg bg-white/10 flex items-center justify-center group-hover:bg-teal-400/20 transition">
                                <i class="fa-solid fa-cloud-arrow-up text-xl text-teal-300"></i>
                            </div>
                            <div class="flex-1">
                                <span class="block font-medium">Change Logo</span>
                                <span class="text-xs text-white/50">PNG, JPG, SVG</span>
                            </div>
                            <input type="file" id="logoUpload" accept="image/*" class="hidden">
                            <img id="logoPreview" src="https://raw.githubusercontent.com/BaselGhanem/Schedule/refs/heads/main/X%20Academy%20Log%20(1).png" class="w-10 h-10 object-contain" alt="Preview" crossorigin="anonymous">
                        </label>
                    </div>
                </div>
            </div>

            <div id="step-2" class="step-content">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold mb-2">Select the Path</h2>
                    <p class="text-white/60">What skills are we mastering?</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <label class="cursor-pointer">
                        <input type="radio" name="courseType" value="excel" class="peer hidden" onchange="handleCourseSelect('excel')">
                        <div class="glass-input p-6 rounded-2xl border-2 border-transparent peer-checked:border-teal-400 peer-checked:bg-teal-400/10 transition h-full flex flex-col items-center text-center">
                            <i class="fa-solid fa-file-excel text-4xl text-green-400 mb-3"></i>
                            <h3 class="font-bold text-lg">Excel Mastery</h3>
                            <p class="text-xs text-white/60 mt-2">Zero to Hero</p>
                        </div>
                    </label>

                    <label class="cursor-pointer">
                        <input type="radio" name="courseType" value="powerbi" class="peer hidden" onchange="handleCourseSelect('powerbi')">
                        <div class="glass-input p-6 rounded-2xl border-2 border-transparent peer-checked:border-yellow-400 peer-checked:bg-yellow-400/10 transition h-full flex flex-col items-center text-center">
                            <i class="fa-solid fa-chart-simple text-4xl text-yellow-400 mb-3"></i>
                            <h3 class="font-bold text-lg">Power BI</h3>
                            <p class="text-xs text-white/60 mt-2">Business Insights</p>
                        </div>
                    </label>
                    
                     <label class="cursor-pointer md:col-span-2">
                        <input type="radio" name="courseType" value="other" class="peer hidden" onchange="handleCourseSelect('other')">
                        <div class="glass-input p-4 rounded-2xl border-2 border-transparent peer-checked:border-blue-400 peer-checked:bg-blue-400/10 transition flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center">
                                <i class="fa-solid fa-pen-nib text-blue-400"></i>
                            </div>
                            <span class="font-bold">Custom Course</span>
                        </div>
                    </label>
                </div>

                <div id="customCourseFields" class="space-y-4">
                    <div>
                        <label class="text-xs uppercase tracking-wider text-white/50 font-bold ml-1">Course Name</label>
                        <input type="text" id="courseName" class="glass-input w-full p-3 rounded-lg mt-1" placeholder="e.g. Advanced Python">
                    </div>
                    <div>
                        <label class="text-xs uppercase tracking-wider text-white/50 font-bold ml-1">Topics (Line by line)</label>
                        <textarea id="courseTopics" rows="4" class="glass-input w-full p-3 rounded-lg mt-1" placeholder="Topic 1&#10;Topic 2"></textarea>
                    </div>
                </div>
            </div>

            <div id="step-3" class="step-content">
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold mb-2">Time & Duration</h2>
                    <p class="text-white/60">When do we start the magic?</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="text-sm font-semibold mb-2 block">Start Date</label>
                        <input type="date" id="startDate" class="glass-input w-full p-3 rounded-xl">
                    </div>
                    <div>
                        <label class="text-sm font-semibold mb-2 block">Start Time</label>
                        <input type="time" id="startTime" value="19:00" class="glass-input w-full p-3 rounded-xl">
                    </div>
                    <div>
                        <label class="text-sm font-semibold mb-2 block">Hours per Session</label>
                        <div class="flex items-center gap-3 glass-input rounded-xl p-1">
                            <button onclick="adjustVal('dailyHours', -0.5)" class="w-10 h-10 flex items-center justify-center hover:bg-white/10 rounded-lg text-lg font-bold">-</button>
                            <input type="number" id="dailyHours" value="2" class="bg-transparent text-center w-full font-bold focus:outline-none" readonly>
                            <button onclick="adjustVal('dailyHours', 0.5)" class="w-10 h-10 flex items-center justify-center hover:bg-white/10 rounded-lg text-lg font-bold">+</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-semibold mb-2 block">Total Hours</label>
                        <div class="flex items-center gap-3 glass-input rounded-xl p-1">
                            <button onclick="adjustVal('totalHours', -1)" class="w-10 h-10 flex items-center justify-center hover:bg-white/10 rounded-lg text-lg font-bold">-</button>
                            <input type="number" id="totalHours" value="18" class="bg-transparent text-center w-full font-bold focus:outline-none" readonly>
                            <button onclick="adjustVal('totalHours', 1)" class="w-10 h-10 flex items-center justify-center hover:bg-white/10 rounded-lg text-lg font-bold">+</button>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <label class="text-sm font-semibold mb-3 block">Training Days</label>
                    <div class="flex flex-wrap gap-3 justify-center">
                        <label class="cursor-pointer">
                            <input type="checkbox" class="hidden day-select day-checkbox" value="0">
                            <div class="w-12 h-12 rounded-full border border-white/20 flex items-center justify-center transition hover:bg-white/10 text-sm">Sun</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="checkbox" class="hidden day-select day-checkbox" value="1">
                            <div class="w-12 h-12 rounded-full border border-white/20 flex items-center justify-center transition hover:bg-white/10 text-sm">Mon</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="checkbox" class="hidden day-select day-checkbox" value="2">
                            <div class="w-12 h-12 rounded-full border border-white/20 flex items-center justify-center transition hover:bg-white/10 text-sm">Tue</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="checkbox" class="hidden day-select day-checkbox" value="3">
                            <div class="w-12 h-12 rounded-full border border-white/20 flex items-center justify-center transition hover:bg-white/10 text-sm">Wed</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="checkbox" class="hidden day-select day-checkbox" value="4">
                            <div class="w-12 h-12 rounded-full border border-white/20 flex items-center justify-center transition hover:bg-white/10 text-sm">Thu</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="checkbox" class="hidden day-select day-checkbox" value="5">
                            <div class="w-12 h-12 rounded-full border border-white/20 flex items-center justify-center transition hover:bg-white/10 text-sm">Fri</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="checkbox" class="hidden day-select day-checkbox" value="6">
                            <div class="w-12 h-12 rounded-full border border-white/20 flex items-center justify-center transition hover:bg-white/10 text-sm">Sat</div>
                        </label>
                    </div>
                    
                    <div class="flex justify-center gap-2 mt-4">
                         <button onclick="setPreset('weekdays')" class="text-xs bg-white/10 px-3 py-1 rounded-full hover:bg-white/20">Mon-Fri</button>
                         <button onclick="setPreset('sundayStart')" class="text-xs bg-white/10 px-3 py-1 rounded-full hover:bg-white/20">Sun-Thu</button>
                    </div>
                </div>
            </div>

            <div id="step-4" class="step-content">
                 <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold mb-2">Holidays?</h2>
                    <p class="text-white/60">Any dates to skip?</p>
                </div>

                <div class="glass-input p-2 rounded-xl flex gap-2">
                    <input type="date" id="newExcludedDate" class="bg-transparent w-full p-2 outline-none text-white">
                    <button onclick="addExcludedDate()" class="bg-teal-500 hover:bg-teal-400 text-white px-4 rounded-lg font-bold transition">
                        Add
                    </button>
                </div>

                <div id="excludedList" class="mt-4 space-y-2 max-h-40 overflow-y-auto">
                    <div class="text-center text-white/30 text-sm italic">No excluded dates yet.</div>
                </div>
            </div>

             <div id="step-5" class="step-content">
                <div class="text-center mb-4">
                    <h2 class="text-2xl font-bold text-teal-300"><i class="fa-solid fa-check-circle mr-2"></i>Schedule Ready!</h2>
                </div>

                <div class="flex gap-3 mb-6">
                    <button onclick="exportExcel()" class="flex-1 bg-green-600/80 hover:bg-green-600 p-3 rounded-xl flex items-center justify-center gap-2 transition font-semibold border border-green-400/30">
                        <i class="fa-solid fa-file-excel"></i> Excel
                    </button>
                    <button onclick="exportPDF()" class="flex-1 bg-red-600/80 hover:bg-red-600 p-3 rounded-xl flex items-center justify-center gap-2 transition font-semibold border border-red-400/30">
                        <i class="fa-solid fa-file-pdf"></i> PDF
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="glass-input p-3 rounded-lg text-center">
                        <div class="text-xs text-white/50 uppercase">Total Hours</div>
                        <div class="text-xl font-bold text-teal-300" id="resTotalHours">0</div>
                    </div>
                    <div class="glass-input p-3 rounded-lg text-center">
                        <div class="text-xs text-white/50 uppercase">Sessions</div>
                        <div class="text-xl font-bold text-blue-300" id="resTotalSessions">0</div>
                    </div>
                </div>

                <div class="overflow-x-auto rounded-xl border border-white/10">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-white/10 text-white uppercase text-xs">
                            <tr>
                                <th class="px-4 py-3">#</th>
                                <th class="px-4 py-3">Date</th>
                                <th class="px-4 py-3">Day</th>
                                <th class="px-4 py-3">Time</th>
                                <th class="px-4 py-3">Action</th>
                            </tr>
                        </thead>
                        <tbody id="resultBody" class="divide-y divide-white/10 bg-black/20">
                            </tbody>
                    </table>
                </div>
            </div>

        </div>

        <div class="p-6 border-t border-white/10 bg-black/20 flex justify-between items-center" id="navFooter">
            <button id="prevBtn" onclick="changeStep(-1)" class="text-white/60 hover:text-white px-4 py-2 hidden">
                Back
            </button>
            
            <div id="stepIndicator" class="text-xs text-white/40 font-mono">Step 1 of 5</div>

            <button id="nextBtn" onclick="changeStep(1)" class="bg-teal-500 hover:bg-teal-400 text-black font-bold py-3 px-8 rounded-full shadow-[0_0_20px_rgba(45,212,191,0.3)] transition transform hover:scale-105 flex items-center gap-2">
                <span>Next</span> <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <script>
        /* --- CONFIGURATION & DATA --- */
        const coursesData = {
            'excel': {
                name: 'Excel Mastery: From Zero to Hero',
                topics: 'Getting Started: Navigate interface, ribbons, commands/n

Create/save workbooks, enter & format data, shortcuts mastery/n

Calculations & Functions: Formulas, XLOOKUP, logical, date/time, text, and dynamic array functions./n

Worksheet & Workbook Management: Insert/delete/adjust cells, columns, rows/n

Find & replace; proofing & research tool

Manage views & workbook properties; links & external references/n

Formatting & Visualization: Text & number formats, alignment, styles & themes, conditional formatting, page setup/n

Headers/footers, print preview; create/modify charts, advanced chart features/n

Lists & Tables: Sort, filter, outline, subtotal, create/modify tables, structured references/n

PivotTables & PivotCharts: Create, analyze, filter with slicers/timelines, present data visually/n

Data Analysis & Insights: Conditional formatting, what-if analysis, data grouping

Scenario manager, basic statistical summaries/n

Sharing & Protection: Collaboration, protect worksheets & workbooks, track changes/n

Automation & Dashboards: Data validation, error checking, formula auditing, dashboard creation/n

Dynamic reporting with slicers & field parameters.

Advanced Tips & Productivity: Power Query basics, keyboard shortcuts, templates, and time-saving hacks'
            },
            'powerbi': {
                name: 'Power BI Business Insights Bootcamp',
                topics: 'Interface & Connectivity\nData Transformation (ETL)\nDAX Modeling\nVisualization & Reporting\nPublishing & Sharing'
            }
        };

        const defaultLogoUrl = "https://raw.githubusercontent.com/BaselGhanem/Schedule/refs/heads/main/X%20Academy%20Log%20(1).png";

        /* --- STATE --- */
        let currentStep = 1;
        const totalSteps = 5;
        let scheduleData = [];
        let excludedDates = [];
        let logoBase64 = null;

        /* --- INITIALIZATION --- */
        // Convert the default image to Base64 specifically for PDF export
        window.addEventListener('DOMContentLoaded', () => {
            const img = document.getElementById('logoPreview');
            // Wait for image to load naturally
            if (img.complete) {
                convertImageToBase64(img);
            } else {
                img.onload = () => convertImageToBase64(img);
            }
        });

        function convertImageToBase64(imgElement) {
            try {
                const canvas = document.createElement("canvas");
                canvas.width = imgElement.naturalWidth;
                canvas.height = imgElement.naturalHeight;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(imgElement, 0, 0);
                logoBase64 = canvas.toDataURL("image/png");
            } catch(e) {
                console.log("Could not convert default logo for PDF (CORS restrictions likely). It will still show on screen.");
            }
        }


        /* --- NAVIGATION LOGIC --- */
        function changeStep(dir) {
            // Validation before going next
            if (dir === 1) {
                if (!validateStep(currentStep)) return;
                
                // If moving to last step, generate!
                if (currentStep === 4) {
                    generateSchedule();
                }
            }

            currentStep += dir;
            updateUI();
        }

        function updateUI() {
            // 1. Show/Hide Step Content
            document.querySelectorAll('.step-content').forEach((el, idx) => {
                if (idx + 1 === currentStep) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });

            // 2. Update Progress Bars
            for (let i = 1; i <= 4; i++) {
                const bar = document.getElementById(`prog-${i}`);
                if (i < currentStep) bar.className = "h-1 w-6 rounded-full bg-teal-400 transition-all"; // Completed
                else if (i === currentStep && currentStep !== 5) bar.className = "h-1 w-12 rounded-full bg-white transition-all"; // Active
                else bar.className = "h-1 w-6 rounded-full bg-white/20 transition-all"; // Pending
            }

            // 3. Update Buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const indicator = document.getElementById('stepIndicator');

            prevBtn.classList.toggle('hidden', currentStep === 1);
            
            if (currentStep === totalSteps) {
                // Result Screen
                nextBtn.innerHTML = '<span>Restart</span> <i class="fa-solid fa-rotate"></i>';
                nextBtn.onclick = resetApp;
                nextBtn.classList.remove('bg-teal-500', 'text-black');
                nextBtn.classList.add('bg-white/10', 'text-white');
                prevBtn.classList.add('hidden'); // No back from result for simplicity in this flow
                indicator.innerText = "Complete";
            } else if (currentStep === 4) {
                 nextBtn.innerHTML = '<span>Generate</span> <i class="fa-solid fa-wand-magic-sparkles"></i>';
                 nextBtn.onclick = () => changeStep(1);
                 nextBtn.className = "bg-gradient-to-r from-teal-400 to-blue-500 hover:from-teal-300 hover:to-blue-400 text-white font-bold py-3 px-8 rounded-full shadow-lg transition transform hover:scale-105 flex items-center gap-2";
                 indicator.innerText = `Step ${currentStep} of ${totalSteps-1}`;
            } else {
                nextBtn.innerHTML = '<span>Next</span> <i class="fa-solid fa-arrow-right"></i>';
                nextBtn.onclick = () => changeStep(1);
                nextBtn.className = "bg-teal-500 hover:bg-teal-400 text-black font-bold py-3 px-8 rounded-full shadow-[0_0_20px_rgba(45,212,191,0.3)] transition transform hover:scale-105 flex items-center gap-2";
                indicator.innerText = `Step ${currentStep} of ${totalSteps-1}`;
            }
        }

        function validateStep(step) {
            if (step === 1) {
                const name = document.getElementById('traineeName').value.trim();
                if (!name) { alert("Please enter the Trainee Name."); return false; }
            }
            if (step === 2) {
                const type = document.querySelector('input[name="courseType"]:checked');
                if (!type) { alert("Please select a course path."); return false; }
                if (type.value === 'other') {
                    if (!document.getElementById('courseName').value.trim()) {
                          alert("Please enter a custom course name."); return false; 
                    }
                }
            }
            if (step === 3) {
                const date = document.getElementById('startDate').value;
                if (!date) { alert("Please select a start date."); return false; }
                const days = document.querySelectorAll('.day-select:checked');
                if (days.length === 0) { alert("Please select at least one training day."); return false; }
            }
            return true;
        }

        /* --- FORM HANDLERS --- */
        function adjustVal(id, amount) {
            const el = document.getElementById(id);
            let val = parseFloat(el.value) + amount;
            if (val < 0.5) val = 0.5;
            el.value = val;
        }

        function handleCourseSelect(type) {
            const customFields = document.getElementById('customCourseFields');
            const nameInput = document.getElementById('courseName');
            const topicsInput = document.getElementById('courseTopics');

            if (type === 'other') {
                customFields.classList.remove('opacity-50', 'pointer-events-none');
                nameInput.value = '';
                topicsInput.value = '';
                nameInput.readOnly = false;
                topicsInput.readOnly = false;
            } else {
                customFields.classList.add('opacity-50', 'pointer-events-none'); // Dim custom fields
                nameInput.value = coursesData[type].name;
                topicsInput.value = coursesData[type].topics;
                nameInput.readOnly = true;
                topicsInput.readOnly = true;
            }
        }

        function setPreset(type) {
            const checkboxes = document.querySelectorAll('.day-select');
            checkboxes.forEach(cb => cb.checked = false);
            if (type === 'weekdays') { // Mon-Fri
                [1,2,3,4,5].forEach(i => document.querySelector(`.day-select[value="${i}"]`).checked = true);
            } else if (type === 'sundayStart') { // Sun-Thu
                [0,1,2,3,4].forEach(i => document.querySelector(`.day-select[value="${i}"]`).checked = true);
            }
        }

        /* --- EXCLUDED DATES --- */
        function addExcludedDate() {
            const input = document.getElementById('newExcludedDate');
            const val = input.value;
            if (val && !excludedDates.includes(val)) {
                excludedDates.push(val);
                excludedDates.sort();
                renderExcludedList();
                input.value = '';
            }
        }

        function renderExcludedList() {
            const list = document.getElementById('excludedList');
            if (excludedDates.length === 0) {
                list.innerHTML = '<div class="text-center text-white/30 text-sm italic">No excluded dates yet.</div>';
                return;
            }
            list.innerHTML = excludedDates.map(date => `
                <div class="flex justify-between items-center bg-white/5 px-3 py-2 rounded">
                    <span>${date}</span>
                    <button onclick="removeExcluded('${date}')" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-times"></i></button>
                </div>
            `).join('');
        }

        function removeExcluded(date) {
            excludedDates = excludedDates.filter(d => d !== date);
            renderExcludedList();
        }

        /* --- GENERATION ENGINE (Core Logic) --- */
        function generateSchedule() {
            // Inputs
            const startDateStr = document.getElementById('startDate').value;
            const startTimeStr = document.getElementById('startTime').value;
            const dailyHours = parseFloat(document.getElementById('dailyHours').value);
            const totalHours = parseFloat(document.getElementById('totalHours').value);
            const selectedDays = Array.from(document.querySelectorAll('.day-select:checked')).map(cb => parseInt(cb.value));

            // Date Parsing (The Fix)
            const [startY, startM, startD] = startDateStr.split('-').map(Number);
            let currentDate = new Date(startY, startM - 1, startD);

            let hoursScheduled = 0;
            scheduleData = [];
            let sessionId = 1;
            const daysMap = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            let safety = 0;
            while (hoursScheduled < totalHours && safety < 365) {
                const dayOfWeek = currentDate.getDay();
                
                // Manual ISO string construction to keep local time
                const year = currentDate.getFullYear();
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const day = String(currentDate.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;

                if (selectedDays.includes(dayOfWeek) && !excludedDates.includes(dateStr)) {
                    let sessionHrs = Math.min(dailyHours, totalHours - hoursScheduled);
                    
                    // Time calc
                    const [h, m] = startTimeStr.split(':').map(Number);
                    const startT = new Date(2000, 0, 1, h, m);
                    const endT = new Date(startT.getTime() + sessionHrs * 60 * 60 * 1000);
                    const endTimeStr = endT.toTimeString().slice(0, 5);

                    scheduleData.push({
                        id: sessionId++,
                        date: dateStr,
                        dayName: daysMap[dayOfWeek],
                        start: startTimeStr,
                        end: endTimeStr,
                        hours: sessionHrs
                    });
                    hoursScheduled += sessionHrs;
                }
                currentDate.setDate(currentDate.getDate() + 1);
                safety++;
            }

            renderResultTable();
            document.getElementById('resTotalHours').innerText = hoursScheduled;
            document.getElementById('resTotalSessions').innerText = scheduleData.length;
        }

        function renderResultTable() {
            const tbody = document.getElementById('resultBody');
            tbody.innerHTML = scheduleData.map((row, idx) => `
                <tr class="hover:bg-white/5 transition">
                    <td class="px-4 py-3 font-mono text-white/50">${row.id}</td>
                    <td class="px-4 py-3 font-medium">${row.date}</td>
                    <td class="px-4 py-3 text-teal-300">${row.dayName}</td>
                    <td class="px-4 py-3 text-sm">${row.start} - ${row.end}</td>
                    <td class="px-4 py-3">
                        <button onclick="removeSession(${idx})" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function removeSession(idx) {
            scheduleData.splice(idx, 1);
            // Re-index
            scheduleData.forEach((r, i) => r.id = i+1);
            renderResultTable();
            // Update summary
            const newTotal = scheduleData.reduce((acc, curr) => acc + curr.hours, 0);
            document.getElementById('resTotalHours').innerText = newTotal;
            document.getElementById('resTotalSessions').innerText = scheduleData.length;
        }

        /* --- EXPORT FUNCTIONS (PDF/Excel) --- */
        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const trainee = document.getElementById('traineeName').value;
            const course = document.getElementById('courseName').value;

            // Header Background (Teal)
            doc.setFillColor(45, 212, 191); 
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255);
            doc.setFontSize(22);
            doc.text("Training Schedule", 14, 20);
            doc.setFontSize(10);
            doc.text(`Trainee: ${trainee}`, 14, 30);
            doc.text(`Course: ${course}`, 14, 35);

            // Logo
            if (logoBase64) {
                 try {
                    // Check if it's base64 or URL (though we try to convert to base64 always now)
                    const format = 'PNG'; 
                    doc.addImage(logoBase64, format, 170, 5, 30, 30);
                 } catch(e) {
                     console.log("Image error", e);
                 }
            }

            // Table
            const bodyData = scheduleData.map(r => [r.id, r.date, r.dayName, `${r.start} - ${r.end}`, r.hours + ' hrs']);
            
            doc.autoTable({
                head: [['#', 'Date', 'Day', 'Time', 'Duration']],
                body: bodyData,
                startY: 50,
                theme: 'striped',
                headStyles: { fillColor: [45, 212, 191] },
                alternateRowStyles: { fillColor: [240, 253, 250] }
            });

            doc.save('Schedule.pdf');
        }

        function exportExcel() {
            const trainee = document.getElementById('traineeName').value;
            const course = document.getElementById('courseName').value;
            
            const wb = XLSX.utils.book_new();
            const ws_data = [
                ["TRAINING SCHEDULE"],
                ["Course", course],
                ["Trainee", trainee],
                [""],
                ["#", "Date", "Day", "Start", "End", "Duration"]
            ];
            
            scheduleData.forEach(r => {
                ws_data.push([r.id, r.date, r.dayName, r.start, r.end, r.hours]);
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Schedule");
            XLSX.writeFile(wb, "Schedule.xlsx");
        }

        /* --- UTILS --- */
        function resetApp() {
            if(confirm("Start over?")) window.location.reload();
        }

        // Logo Upload Handler
        document.getElementById('logoUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(file){
                const reader = new FileReader();
                reader.onload = function(evt) {
                    logoBase64 = evt.target.result;
                    document.getElementById('logoPreview').src = logoBase64;
                };
                reader.readAsDataURL(file);
            }
        });
    </script>
</body>
</html>

